name: Build Kivy APK
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    # Using the official Buildozer Docker image eliminates local macro errors
    container:
      image: kivy/buildozer:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Permissions
        run: |
          # The Docker container runs as root, but buildozer shouldn't.
          # We ensure the workspace is owned by the buildozer user.
          chown -R $USER:$USER .

      - name: Build APK
        shell: bash
        run: |
          # Use the 'user' account inside the container to run the build
          su user -c "
          export PATH=\$PATH:/home/user/.local/bin
          
          # 1. First run to trigger SDK/NDK downloads
          buildozer -v android debug || true
          
          # 2. Apply your AIDL fix inside the container
          echo 'Applying AIDL fix...'
          SYSTEM_AIDL=\$(which aidl)
          SDK_DIR=\$(find . -name 'build-tools' -type d -path '*/android-sdk/*' | head -n 1)
          
          if [ -n \"\$SDK_DIR\" ]; then
            VERSION_FOLDER=\$(ls -1 \"\$SDK_DIR\" | head -n 1)
            TARGET_PATH=\"\$SDK_DIR/\$VERSION_FOLDER\"
            ln -sf \"\$SYSTEM_AIDL\" \"\$TARGET_PATH/aidl\"
          fi
          
          # 3. Final Build
          buildozer -v android debug
          "

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: package
          path: bin/*.apk
